#property copyright "Copyright 2025, MetaQuotes Ltd."
#property link      "https://www.mql5.com"

#include <Trade\Trade.mqh>
 
bool HasBuyLimitOrder(string symbol)
{
   int total = OrdersTotal();
   for (int i = 0; i < total; i++)
   {
      if (OrderGetTicket(i))
      {
         if (OrderGetString(ORDER_SYMBOL) == symbol &&
             (int)OrderGetInteger(ORDER_TYPE) == ORDER_TYPE_BUY_LIMIT)
         {
            return true;
         }
      }
   }
   return false;
}

double GetSmallestBuyPrice()
{
   double min_price = DBL_MAX;  // Start with max possible value
   int total = PositionsTotal();

   for (int i = 0; i < total; i++)
   {
      if (PositionGetTicket(i))
      {
         int type = (int)PositionGetInteger(POSITION_TYPE);
         double volume = PositionGetDouble(POSITION_VOLUME);
         if (type == POSITION_TYPE_BUY && volume!=1)
         {
            double price = PositionGetDouble(POSITION_PRICE_OPEN);
            if (price < min_price)
               min_price = price;
         }
      }
   }

   // If no buy positions found, return -1 or handle accordingly
   return (min_price == DBL_MAX) ? -1 : min_price;
}
bool HasBuyLimitAtPrice(double targetPrice, long magic = 0)
{
   for (int i = 0; i < OrdersTotal(); i++)
   {
      ulong ticket = OrderGetTicket(i);
      if (ticket > 0)
      {
         if (OrderGetString(ORDER_SYMBOL) == _Symbol &&
             OrderGetInteger(ORDER_TYPE) == ORDER_TYPE_BUY_LIMIT &&
             MathAbs(OrderGetDouble(ORDER_PRICE_OPEN) - targetPrice) < _Point*2 &&
             (magic == 0 || OrderGetInteger(ORDER_MAGIC) == magic))
         {
            return true;
         }
      }
   }
   return false;
}
double GetHighestBuyLimitPrice(string symbol)
{
   double highest_price = -1;
   int total = OrdersTotal();

   for (int i = 0; i < total; i++)
   {
      if (OrderGetTicket(i))
      {
         int type = (int)OrderGetInteger(ORDER_TYPE);
         string order_symbol = OrderGetString(ORDER_SYMBOL);
         double price = OrderGetDouble(ORDER_PRICE_OPEN);

         if (type == ORDER_TYPE_BUY_LIMIT && order_symbol == symbol)
         {
            if (price > highest_price)
               highest_price = price;
         }
      }
   }

   return highest_price;
}

//--- ------------- Buy Stop --------------------------
bool HasBuyStopOrder(string symbol)
{
   int total = OrdersTotal();
   for (int i = 0; i < total; i++)
   {
      if (OrderGetTicket(i))
      {
         if (OrderGetString(ORDER_SYMBOL) == symbol &&
             (int)OrderGetInteger(ORDER_TYPE) == ORDER_TYPE_BUY_STOP)
         {
            return true;
         }
      }
   }
   return false;
}


double GetHighestBuyPrice()
{
   double max_price = -1;
   int total = PositionsTotal();

   for(int i = 0; i < total; i++)
   {
      ulong ticket = PositionGetTicket(i);
      if(ticket > 0 && PositionSelectByTicket(ticket))
      {
         int type = (int)PositionGetInteger(POSITION_TYPE);
         if(type == POSITION_TYPE_BUY)
         {
            double price = PositionGetDouble(POSITION_PRICE_OPEN);
            if(price > max_price)
               max_price = price;
         }
      }
   }
   return (max_price == -1) ? -1 : max_price;
}
double GetLowestBuyStopPrice(string symbol)
{
   double lowest_price = DBL_MAX; // ???????????????????
   int total = OrdersTotal();

   for (int i = 0; i < total; i++)
   {
      ulong ticket = OrderGetTicket(i);
      if (ticket > 0)
      {
         int type = (int)OrderGetInteger(ORDER_TYPE);
         string order_symbol = OrderGetString(ORDER_SYMBOL);
         double price = OrderGetDouble(ORDER_PRICE_OPEN);

         if (type == ORDER_TYPE_BUY_STOP && order_symbol == symbol)
         {
            if (price < lowest_price)
               lowest_price = price;
         }
      }
   }

   // ????????? Buy Stop ?????????? -1
   if (lowest_price == DBL_MAX)
      return -1;

   return lowest_price;
}
bool HasBuyStopAtPrice(double targetPrice, long magic = 0)
{
   for (int i = 0; i < OrdersTotal(); i++)
   {
      ulong ticket = OrderGetTicket(i);
      if (ticket > 0)
      {
         if (OrderGetString(ORDER_SYMBOL) == _Symbol &&
             OrderGetInteger(ORDER_TYPE) == ORDER_TYPE_BUY_STOP &&
             MathAbs(OrderGetDouble(ORDER_PRICE_OPEN) - targetPrice) < _Point*2 &&
             (magic == 0 || OrderGetInteger(ORDER_MAGIC) == magic))
         {
            return true; // ??? Buy Stop ??????????
         }
      }
   }
   return false; // ????? Buy Stop ??????????
}
