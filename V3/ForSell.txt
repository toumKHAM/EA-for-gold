#property copyright "Copyright 2025, MetaQuotes Ltd."
#property link      "https://www.mql5.com"

#include <Trade\Trade.mqh>
//CTrade trade;


struct SellInfo
{
   int count;
   double max_price;
   double max_lot_size1;
   double max_lot_size2;
   double sell_limit_price;
};


SellInfo GetSellInfo()
{

    SellInfo info;
    info.count = 0;
    info.max_price = -1;
    info.max_lot_size1 = 0;
    info.max_lot_size2 = 0;
    info.sell_limit_price = -1;
    
    
    int total = PositionsTotal(); // ???????? positions ??????????

    for(int i = 0; i < total; i++)
    {
        if(PositionGetTicket(i)) // ????? position ??? index
        {
            long   type       = PositionGetInteger(POSITION_TYPE);
            double volume = PositionGetDouble(POSITION_VOLUME);

            if(type == POSITION_TYPE_SELL && volume!=5 ){
               // count
               info.count++; 
               
               // max
               double price = PositionGetDouble(POSITION_PRICE_OPEN);
               if (price > info.max_price){
                  info.max_price = price;
               }
               
               // lot
               // double volume = PositionGetDouble(POSITION_VOLUME);
               if (volume > info.max_lot_size1){
                  info.max_lot_size2 = info.max_lot_size1;
                  info.max_lot_size1 = volume;
                  
               }
            }
        }
    }
    
    int total2 = OrdersTotal();
    for (int i = 0; i < total2; i++)
    {
      if (OrderGetTicket(i))
      {
         if ((int)OrderGetInteger(ORDER_TYPE) == ORDER_TYPE_SELL_LIMIT)
         {
            double price = OrderGetDouble(ORDER_PRICE_OPEN);
            if (price > info.sell_limit_price){
                  info.sell_limit_price = price;
            }
         }
      }
    }
    return info;
}


bool ModifySellTP(string symbol, double newTP)
{
   bool in_status = true;
   Print("----- Start ModifySellTP --- ");
   int total = PositionsTotal(); // ????? positions ??????????
   for(int i = 0; i < total; i++)
   {
      if(PositionGetTicket(i)) // ????? position ??? index
      {
         string pos_symbol = PositionGetString(POSITION_SYMBOL);
         long   type       = PositionGetInteger(POSITION_TYPE);
         double volume = PositionGetDouble(POSITION_VOLUME);
         double old_tp = PositionGetDouble(POSITION_TP);
         
         if(type == POSITION_TYPE_SELL && pos_symbol == symbol && volume != 5 )
         {
            
            ulong  ticket = PositionGetInteger(POSITION_TICKET);
            // Print(ticket," old TP ------> ",old_tp," new TP ------> ",newTP);
            if(newTP != old_tp){
               bool result = trade.PositionModify(ticket, 0, newTP);
            
               if(result == false){
                  Print(ticket,"--------------------------->>>>>>>>>>>>>>> Error");
                  in_status = false;
               }else{
                  // Print(ticket," update new TP finish");
               }
            }else{
               Print(ticket," No update");
            }
            
         }
      }
   }
   Print("----- End ModifySellTP --- ");
   return in_status;
}

void CloseAllSell(string symbol)
{
   int total = PositionsTotal();

   for(int i = total - 1; i >= 0; i--) // ??????????????????????? index error
   {
      if(PositionGetTicket(i))
      {
         string pos_symbol = PositionGetString(POSITION_SYMBOL);
         long   type       = PositionGetInteger(POSITION_TYPE);

         if(type == POSITION_TYPE_SELL && pos_symbol == symbol)
         {
            trade.PositionClose(symbol);
         }
      }
   }
}

void DeleteAllSellLimit(string symbol = NULL)
{
   int total = OrdersTotal();
   for(int i = total - 1; i >= 0; i--) // ???????? order ???????
   {
      ulong ticket = OrderGetTicket(i);
      if(OrderSelect(ticket))
      {
         string sym = OrderGetString(ORDER_SYMBOL);
         int type   = (int)OrderGetInteger(ORDER_TYPE);

         if(type == ORDER_TYPE_SELL_LIMIT && (symbol == NULL || sym == symbol))
         {
            trade.OrderDelete(ticket);
         }
      }
   }
}
